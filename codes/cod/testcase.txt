# STAGE 3 & 4
#     sram and serial

from TestcaseBase import *
import random
import traceback
import time

class Testcase(TestcaseBase):
    nRound = 5
    finishedRound = 0
    roundPassed = 0

    def launchTest(self):

        self.start_addr = random.getrandbits(7)
        self.send_data = bytes([random.getrandbits(8) for i in range(10)])
        self.log(f"## Test round {self.finishedRound} with Addr={self.start_addr:#02x}")

        # Set initial memory address
        DIP << self.start_addr
        ~Reset
        self.recvBuf = b''
        Serial.open(0, baud=9600)

        # Send 10 bytes
        for data in self.send_data:
            time.sleep(1/1000.0)
            Serial << data

        # Wait for receiving data, timeout in 50ms
        Timer.oneshot(50)

    # On receiving from serial port
    @Serial
    def on_serial(self, dataBytes):
        self.recvBuf += dataBytes
        if len(self.recvBuf) >= 10:
            -Timer
            self.nextRound(False)

    @Timer
    def on_timer(self):
        self.nextRound(True)

    def nextRound(self, timeout:bool):
        Serial.close()

        # Read the data in BaseRAM
        memData = list(BaseRAM[self.start_addr*4 : (self.start_addr+len(self.send_data))*4])
        memData = memData[::4]

        self.log(f"Data Sent:   {list(self.send_data)}")
        self.log(f"Data in RAM: {memData}")
        self.log(f"Received:    {list(self.recvBuf)} {'(Timeout)' if timeout else ''}")

        # Compare the data
        failed = timeout or self.send_data!=self.recvBuf or self.send_data!=bytes(memData)
        if failed:
            self.log("FAILED")
        else:
            self.roundPassed += 1
            self.log("PASSED")

        self.finishedRound += 1
        if self.finishedRound == self.nRound:
            self.finish(self.roundPassed/self.nRound)
        else:
            self.launchTest()

    @started
    def initialize(self):
        random.seed(260817) # deterministic random number
        self.launchTest()
